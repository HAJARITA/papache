<?xml version="1.0" encoding="UTF-8"?>

<project name="Papache" default="help">
  <property name="templateDir" value="${project.basedir}/templates"/>
  <property name="taskDir" value="${project.basedir}/tasks"/>
  <property file="${project.basedir}/papache.properties"/>
  <echo message="taskdir=${taskDir}"/>
  <taskdef name="drush" classname="DrushTask"
           classpath="${taskDir}/phingdrushtask"/>


  <!-- Default task : display the available major targets  -->
  <target name="help">
    <echo message="This is a help text with the different options. Well not yet, but it will ... someday."/>
  </target>


  <!-- Major target: Install Drupal and create the virtual host -->
  <target name="dcreate" depends="checkParams">
    <phingCall target="drupalDownloadInstall"/>
    <phingCall target="vhcreate"/>
  </target>

  <target name="ddestroy" depends="checkParams">
    <phingCall target="vhdestroy"/>
    <phingCall target="drupalDBDestroy"/>
  </target>


  <!-- Major target: Virtual host creation-->
  <target name="vhcreate" depends="checkParams">
    <echo message="Creating (if it doesn't exist) the ${vhostname} virtual host at ${filesys.docroot}"/>
    
    <mkdir dir="${filesys.docroot}"/>
    <chown file="${filesys.docroot}" 
           user="${filesys.siteowner}.${filesys.sitegrp}" 
           verbose="true" 
           failonerror="false"/>


    <!-- write vhosts file with the information -->    
    <echo message="Creating virtual host ${vhostname}"/>
    <copy file="${templateDir}/vhost_template.conf" 
          tofile="/etc/apache2/sites-available/${vhostname}.conf" 
          overwrite="true">
      <filterchain>
        <replaceregexp>
          <regexp pattern="##SERVNAME##" replace="${vhostname}" ignoreCase="true" />
          <regexp pattern="##DOCROOT##" replace="${filesys.docroot}" ignoreCase="false" />
        </replaceregexp>
      </filterchain> 
    </copy>
 
    <!-- apply site and reload apache configs -->
    <exec command="a2ensite ${vhostname}.conf" />
    <exec command="/etc/init.d/apache2 reload" />

    <!-- update hosts file -->
    <phingCall target="addLocalhost"/>
  </target>


  <!-- Major target: Delete an existing virtual host, but keep the docroot data directory -->
  <target name="vhdestroy" depends="checkParams"> 
    <echo message="Deleting virtual host ${vhostname}"/>
    <exec command="a2dissite ${vhostname}.conf"/>
    <exec command="/etc/init.d/apache2 reload"/>
    <delete file="/etc/apache2/sites-available/${vhostname}.conf"/>
    <phingCall target="deleteLocalhost"/>
  </target>

  <!-- Create a new drupal installation using drush make and drush site-install -->
  <target name="drupalDownloadInstall" depends="checkParams">
    <echo message="Building Drupal using the '${drupal.makefile} makefile"/> 
    <!-- The virtual host directory will be recreated by drush make -->
    <delete dir="${filesys.docroot}" quiet="true" includeemptydirs="true"/>
    <drush command="make" assume="yes">
      <param>${drupal.makefile}</param>
      <param>${filesys.apacheroot}/${vhostname}</param>
    </drush>

    <!-- Make sure the site files belong to a given user and not root -->
    <chown user="${filesys.siteowner}.${filesys.sitegrp}" 
           verbose="false" 
           failonerror="false">
      <fileset dir="${filesys.docroot}"/>
    </chown>

    <!-- Don't use dots in the database name -->
    <php expression="str_replace('.','_', '${vhostname}')" returnProperty="dbname"/>
    <drush command="site-install" assume="yes">
      <option name="root">${filesys.apacheroot}/${vhostname}</option>
      <option name="db-url">mysql://${mysql.user}:${mysql.password}@${mysql.host}/${dbname}</option>
      <param>${drupal.profile}</param> 
    </drush>
  </target>

  <target name="drupalDBDestroy" depends="checkParams">
    <!-- Don't use dots in the database name -->
    <php expression="str_replace('.','_', '${vhostname}')" returnProperty="dbname"/>
    <exec command="mysqladmin -u${mysql.user} -p${mysql.password} drop ${dbname}" passthru="true"/>    
  </target>

  <!-- Add the virtual host entry to the /etc/hosts file -->
  <target name="addLocalhost" depends="checkParams">
    <append destFile="/etc/hosts" text="${line.separator}127.0.0.1  ${vhostname}${line.separator}" />
  </target>


  <!-- Delete the virtual host entry from the /etc/hosts file -->
  <target name="deleteLocalhost" depends="checkParams">
    
    <!-- It is simple and faster to use sed instead of a reflexive task and filterchains -->
    <php expression="str_replace('.','\.', '${vhostname}')" returnProperty="cleanVhostname"/>
    <exec command="sed -i '/${cleanVhostname}/d' /etc/hosts"/>

    <if>
      <isTrue value="${options.deleteData}"/>
      <then>
        <delete dir="${filesys.docroot}" quiet="true" includeemptydirs="true"/>
      </then>
    </if>

  </target>


  <!-- Load for the properties file and check cumpulsory arguments -->
  <target name="checkParams">
    <property name="drupal.makefile" value="${templateDir}/default.make"/>
    <property name="drupal.profile" value="standard"/>

    <!-- Define generic defaults -->
    <property name="filesys.apacheroot" value="/var/www"/>
    <property name="filesys.siteowner" value="root"/>
    <property name="filesys.sitegrp" value="root"/>
    <property name="options.deleteData" value="false"/>

    <fail unless="vhostname" message="No virtual host name! Check the help text for options." />
    
    <!-- Allow for custom docroot if one is passed as a property -->
    <property name="filesys.docroot" value="${filesys.apacheroot}/${vhostname}"/>
  </target>

</project>
